/*********************************************************
  SEMÁFORO B (sin sensor)
  WiFi + MQTT + control de LEDs
**********************************************************/

#include <WiFi.h>
#include <PubSubClient.h>

#define LED_ROJO 7
#define LED_VERDE 6

const String ssid = "Wokwi-GUEST";
const String password = "";
const String mqtt_server = "test.mosquitto.org";
const String mqtt_user = "";
const String mqtt_pass = "";

WiFiClient wClient;
PubSubClient mqtt_client(wClient);

String ID_PLACA = "SemaforoB";
String topic_PUBLICACION = "semaforo/B/publica";
String topic_SUSCRIPCION = "semaforo/A/publica";

bool verdeB = false;
unsigned long tiempoCambio = 0;
const unsigned long intervalo = 5000;

//-----------------------------------------------------
void conecta_wifi() {
  Serial.println("Conectando a WiFi...");
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(200);
    Serial.print(".");
  }
  Serial.println("\nConectado! IP: " + WiFi.localIP().toString());
}

//-----------------------------------------------------
void conecta_mqtt() {
  while (!mqtt_client.connected()) {
    Serial.print("Conectando a broker MQTT...");
    if (mqtt_client.connect(ID_PLACA.c_str(), mqtt_user.c_str(), mqtt_pass.c_str())) {
      Serial.println(" conectado!");
      mqtt_client.subscribe(topic_SUSCRIPCION.c_str());
    } else {
      Serial.println(" fallo, reintento en 5s");
      delay(5000);
    }
  }
}

//-----------------------------------------------------
void procesa_mensaje(char* topic, byte* payload, unsigned int length) {
  String msg = "";
  for (int i = 0; i < length; i++) msg += (char)payload[i];
  Serial.println("Mensaje recibido: " + msg);

  if (msg == "VERDE") verdeB = false; // si A está verde → B rojo
  if (msg == "ROJO")  verdeB = true;  // si A está rojo → B verde
}

//-----------------------------------------------------
void publicaEstado() {
  String estado = verdeB ? "VERDE" : "ROJO";
  mqtt_client.publish(topic_PUBLICACION.c_str(), estado.c_str());
  Serial.println("Publicado: " + estado);
}

//-----------------------------------------------------
void setup() {
  Serial.begin(115200);
  pinMode(LED_ROJO, OUTPUT);
  pinMode(LED_VERDE, OUTPUT);

  conecta_wifi();
  mqtt_client.setServer(mqtt_server.c_str(), 1883);
  mqtt_client.setCallback(procesa_mensaje);
  conecta_mqtt();
  publicaEstado();
}

//-----------------------------------------------------
void loop() {
  if (!mqtt_client.connected()) conecta_mqtt();
  mqtt_client.loop();

  unsigned long ahora = millis();

  if (ahora - tiempoCambio > intervalo) {
    verdeB = !verdeB;
    tiempoCambio = ahora;
    publicaEstado();
  }

  digitalWrite(LED_VERDE, verdeB);
  digitalWrite(LED_ROJO, !verdeB);

  delay(200);
}
